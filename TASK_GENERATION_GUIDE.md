# Task Generation Debugging Guide

## The Issue
Tasks generated by Claude are not appearing in Firestore storage.

## Diagnosis Steps

### 1. Check Server Logs
When a goal is created, you should see these log messages:

```
[Background] Starting plan generation for goal {goalId}
[LLM] Initializing Claude API for goal: {goal name}
[LLM] Sending request to Claude API...
[LLM] Raw response received, length: {number}
[LLM] Attempting to parse JSON, length: {number}
[LLM] Successfully parsed JSON response
[LLM] Parsed plan data: { summaryLength, tasksCount, milestonesCount, resourcesCount }
[LLM] Transformation complete: { planGenerated: true, tasksGenerated: X, resourcesGenerated: Y }
[Background] AI plan generated for goal {goalId}: { tasksGenerated: X, resourcesGenerated: Y, milestonesGenerated: Z }
[Background] Goal {goalId} updated with plan and resources
[Background] Creating X tasks for goal {goalId}
[Background] Sample task data: { ... }
[Background] userId: {email}
[Background] ✅ Successfully created X tasks in Firestore for goal {goalId}
[Background] Task IDs: task1, task2, task3...
```

### 2. Common Issues

#### Issue A: API Key Not Configured
**Symptoms**: Error "ANTHROPIC_API_KEY not configured"
**Solution**: Add `ANTHROPIC_API_KEY` to your `.env.local` file or Vercel environment variables

#### Issue B: Wrong Model Name (404 Error)
**Symptoms**: `404 {"type":"error","error":{"type":"not_found_error","message":"model: claude-3-5-sonnet-20240620"}}`
**Solution**: ✅ Already fixed - updated to `claude-sonnet-4-5-20250929`

#### Issue C: Tasks Generated But Not Saved
**Symptoms**: Logs show tasks generated but they don't appear in Firestore
**Possible Causes**:
1. Firebase Admin SDK not initialized properly
2. User ID mismatch
3. Firestore security rules blocking writes
4. Background function timing out before completion

#### Issue D: Tasks Saved But Not Visible
**Symptoms**: Tasks exist in Firestore but UI doesn't show them
**Possible Causes**:
1. Frontend querying wrong collection path
2. User ID mismatch in queries
3. Goal ID mismatch between task.goalId and actual goal
4. Firestore indexes not created for queries

### 3. Manual Verification

#### Check Firestore Console
1. Go to Firebase Console → Firestore Database
2. Navigate to: `/users/{userId}/tasks/`
3. Verify tasks exist with these fields:
   - `goalId`: matches the goal ID
   - `title`: task title from Claude
   - `description`: task description
   - `dueDate`: ISO 8601 date string
   - `completed`: false
   - `createdAt`: timestamp
   - `milestoneId`: optional milestone reference

#### Test API Endpoint
```bash
# Get all tasks for a user
curl http://localhost:3000/api/tasks \\
  -H "Cookie: your-session-cookie"

# Get tasks for a specific goal
curl http://localhost:3000/api/tasks?goalId=YOUR_GOAL_ID \\
  -H "Cookie: your-session-cookie"
```

### 4. Data Flow

```
User creates goal
  ↓
POST /api/goals/create
  ↓
Goal created with status: 'processing'
  ↓
generatePlanInBackground() runs async
  ↓
generatePlanWithClaude() calls Claude API
  ↓
Claude returns: { planSummary, tasks[], milestones[], insights[], resources[] }
  ↓
Tasks transformed: AI format → Firestore format
  ↓
Tasks saved: createTasksBatch(userId, tasks)
  ↓
Tasks synced to Google Calendar (optional)
  ↓
Goal status updated to: 'ready'
```

### 5. Expected Task Format

**From Claude (AI response)**:
```json
{
  "title": "Week 1: Easy run - 3 miles",
  "description": "Start with a comfortable pace...",
  "startDateTime": "2025-10-28T07:00:00Z",
  "endDateTime": "2025-10-28T07:45:00Z",
  "priority": "high",
  "milestoneId": "milestone-1"
}
```

**Transformed for Firestore**:
```json
{
  "goalId": "abc123",
  "title": "Week 1: Easy run - 3 miles",
  "description": "Start with a comfortable pace...",
  "dueDate": "2025-10-28T07:00:00Z",
  "completed": false,
  "milestoneId": "milestone-1",
  "createdAt": "2025-10-28T05:00:00.000Z",
  "updatedAt": "2025-10-28T05:00:00.000Z"
}
```

### 6. Debugging Commands

```bash
# Check if dev server is running
lsof -ti:3000

# View real-time logs (production)
vercel logs

# Test task generation locally (requires ANTHROPIC_API_KEY in .env.local)
npx tsx scripts/test-llm-generation.ts
```

### 7. Quick Fix Checklist

- [ ] `ANTHROPIC_API_KEY` is set in environment variables
- [ ] Model name is `claude-sonnet-4-5-20250929` (not the old one)
- [ ] Firebase Admin SDK initialized successfully (check logs)
- [ ] Background function is completing (not timing out)
- [ ] User ID is consistent between goal creation and task creation
- [ ] Firestore security rules allow task writes
- [ ] Server logs show "✅ Successfully created X tasks"

### 8. If Tasks Still Don't Appear

**Option 1: Check the actual Firestore data**
- Use Firebase Console to manually inspect the database
- Look for `/users/{userId}/tasks/` collection
- Verify goalId matches your created goal

**Option 2: Enable more detailed logging**
The code now has extensive logging with `[LLM]` and `[Background]` prefixes.
Check your logs carefully for any errors.

**Option 3: Test with a simple goal**
Try creating a goal like "Learn to code in 1 week" with minimal constraints
to verify the basic flow works.

## Current Implementation Status

✅ Claude Sonnet 4.5 model updated
✅ Enhanced prompt engineering with task scheduling
✅ Robust JSON parsing with validation
✅ Task transformation from AI → Firestore format
✅ Comprehensive debug logging
✅ Background task creation integrated
✅ Google Calendar sync support

## Next Steps

1. **Check your deployed app logs** (Vercel dashboard)
2. **Verify ANTHROPIC_API_KEY is set** in your deployment environment
3. **Create a test goal** and watch the logs
4. **Inspect Firestore** to see if tasks appear
5. **Check the frontend** to verify it's querying the right collection

If tasks are being created but not visible in the UI, the issue is likely in the frontend query logic, not the backend generation.
